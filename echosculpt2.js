import*as e from"three";import{OrbitControls as r}from"three/addons/controls/OrbitControls.js";import{GLTFLoader as n}from"three/addons/loaders/GLTFLoader.js";import*as t from"tone";import{CubeCamera as o,WebGLCubeRenderTarget as a}from"three";import{ShaderMaterial as i,Color as s}from"three";import*as m from"@tweenjs/tween.js";var vertexShader=`
  varying vec3 vUv; 

  void main() {
    vUv = position; 

    vec4 modelViewPosition = modelViewMatrix * vec4(position, 1.0);
    gl_Position = projectionMatrix * modelViewPosition; 
  }
`,fragmentShader=`
  uniform vec3 color;
  varying vec3 vUv;

  void main() {
    gl_FragColor = vec4(color, 1.0);
  }
`;let scene=new e.Scene,camera=new e.PerspectiveCamera(75,window.innerWidth/window.innerHeight,.1,1e3),renderer=new e.WebGLRenderer;renderer.setSize(window.innerWidth,window.innerHeight),document.body.appendChild(renderer.domElement);let controls=new r(camera,renderer.domElement);controls.enablePan=!1,controls.speed=.01,camera.position.z=5;let ambientLight=new e.AmbientLight(16777215,.2);scene.add(ambientLight);let directionalLight=new e.DirectionalLight(8026746,.5);directionalLight.position.set(1,1,1).normalize(),scene.add(directionalLight);let loader=new n,mesh;loader.load("model.glb",function(e){mesh=e.scene.children[0],scene.add(e.scene),e.scene.traverse(e=>{e.isMesh&&e.geometry.computeBoundingBox()})},function(e){console.log(e.loaded/e.total*100+"% loaded")},function(e){console.log("An error happened",e)});let raycaster=new e.Raycaster,mouse=new e.Vector2;window.addEventListener("mousedown",onMouseClick,!1);let bgloader=new e.TextureLoader,bgTexture=bgloader.load("background.jpg"),bgMaterial=new e.MeshBasicMaterial({map:bgTexture,side:e.BackSide}),bgMesh=new e.Mesh(new e.SphereGeometry(1,60,40),bgMaterial);bgMesh.scale.setScalar(1e3),bgMesh.name="background",scene.add(bgMesh),renderer.autoClear=!0;let synthTypes={synth1:t.Synth,synth2:t.AMSynth,synth3:t.FMSynth,synth4:t.MonoSynth},materials=[new e.ShaderMaterial({uniforms:{color:{value:new e.Color(16711680)}},vertexShader:vertexShader,fragmentShader:fragmentShader}),new e.ShaderMaterial({uniforms:{color:{value:new e.Color(65280)}},vertexShader:vertexShader,fragmentShader:fragmentShader}),new e.ShaderMaterial({uniforms:{color:{value:new e.Color(255)}},vertexShader:vertexShader,fragmentShader:fragmentShader}),new e.ShaderMaterial({uniforms:{color:{value:new e.Color(4915330)}},vertexShader:vertexShader,fragmentShader:fragmentShader}),];function normalize(e,r,n){return(e-r)/(n-r)}function mapPositionToNote(r,n){n.geometry.computeBoundingBox();let t=new e.Vector3(normalize(r.x,n.geometry.boundingBox.min.x,n.geometry.boundingBox.max.x),normalize(r.y,n.geometry.boundingBox.min.y,n.geometry.boundingBox.max.y),normalize(r.z,n.geometry.boundingBox.min.z,n.geometry.boundingBox.max.z));if(t.y<.15)return{note:"C"+Math.floor(t.x*4+4)+"",synthType:"synth1",material:materials[0]};if(t.y<.3)return{note:"D"+Math.floor(t.x*4+4)+"",synthType:"synth4",material:materials[1]};if(t.y<.45)return{note:"E"+Math.floor(t.x*4+6)+"",synthType:"synth2",material:materials[2]};if(t.y<.6)return{note:"E"+Math.floor(t.x*4+5)+"",synthType:"synth1",material:materials[0]};if(t.y<.75)return{note:"E"+Math.floor(t.x*4+4)+"",synthType:"synth2",material:materials[1]};else if(t.y<.9)return{note:"G"+Math.floor(t.x*4+4)+"",synthType:"synth3",material:materials[2]};else return{note:"B"+Math.floor(t.x*4+4)+"",synthType:"synth4",material:materials[3]}}function onMouseClick(r){mouse.x=r.clientX/window.innerWidth*2-1,mouse.y=-(2*(r.clientY/window.innerHeight))+1,raycaster.setFromCamera(mouse,camera);let n=raycaster.intersectObjects(scene.children,!0);if((n=n.filter(e=>"background"!==e.object.name)).length>0){let t=n[0],{note:o,synthType:a,material:i}=mapPositionToNote(t.point,t.object);new synthTypes[a]().toDestination().triggerAttackRelease(o,"8n"),new m.Tween(t.object.material.color).to(i.color,5e3).start();let s=new e.PointLight(i.color,1.5,100);s.position.copy(t.point),scene.add(s),new m.Tween(s).to({intensity:0},500).onComplete(()=>scene.remove(s)).start()}}function updateBackground(){let r=new a(64,{format:e.RGBFormat,generateMipmaps:!0,minFilter:e.LinearMipmapLinearFilter}),n=new o(.1,1e3,r);n.position.copy(camera.position),n.update(renderer,scene),scene.background=r.texture}function animate(){requestAnimationFrame(animate),controls.update(),renderer.render(scene,camera),m.update(),updateBackground()}animate();